name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©UTCæ—¶é—´2ç‚¹è¿è¡Œæ£€æŸ¥
    - cron: '0 2 * * *'

jobs:
  validate:
    name: é…ç½®éªŒè¯
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install yamllint
        
    - name: éªŒè¯YAMLæ–‡ä»¶
      run: |
        echo "éªŒè¯YAMLé…ç½®æ–‡ä»¶æ ¼å¼..."
        find . -name "*.yaml" -o -name "*.yml" | head -20 | xargs -I {} yamllint {}
        echo "âœ… YAMLæ–‡ä»¶æ ¼å¼éªŒè¯å®Œæˆ"
        
    - name: æ£€æŸ¥Markdowné“¾æ¥
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/workflows/mlc_config.json'
        
    - name: éªŒè¯è„šæœ¬å¯æ‰§è¡Œæ€§
      run: |
        echo "éªŒè¯Shellè„šæœ¬..."
        find scripts/ -name "*.sh" -exec bash -n {} \;
        echo "âœ… Shellè„šæœ¬è¯­æ³•éªŒè¯å®Œæˆ"
        
    - name: æ£€æŸ¥æ–‡ä»¶ç»“æ„
      run: |
        echo "éªŒè¯é¡¹ç›®æ–‡ä»¶ç»“æ„..."
        required_files=(
          "CLAUDE.md"
          "README.md"
          "CONTRIBUTING.md"
          "PROJECT_PROGRESS.md"
          "config/commands.yaml"
          "config/hooks.yaml"
          "config/mcp-servers.yaml"
          "agents/pm-agent.md"
        )
        
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        echo "âœ… æ–‡ä»¶ç»“æ„éªŒè¯å®Œæˆ"

  agent-config-check:
    name: Agenté…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: éªŒè¯Agenté…ç½®æ–‡ä»¶
      run: |
        echo "éªŒè¯Agenté…ç½®æ–‡ä»¶..."
        agent_files=(
          "agents/pm-agent.md"
          "agents/architect-agent.md"
          "agents/frontend-agent.md"
          "agents/backend-agent.md"
          "agents/devops-agent.md"
          "agents/qa-agent.md"
        )
        
        for agent in "${agent_files[@]}"; do
          if [[ -f "$agent" ]]; then
            echo "âœ… $agent é…ç½®å­˜åœ¨"
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„ç« èŠ‚
            if grep -q "## ğŸ¯ è§’è‰²å®šä¹‰" "$agent" && \
               grep -q "## ğŸ“‹ æ ¸å¿ƒèŒè´£" "$agent" && \
               grep -q "## ğŸ› ï¸ ä¸»è¦å·¥å…·" "$agent"; then
              echo "âœ… $agent æ ¼å¼æ­£ç¡®"
            else
              echo "âŒ $agent ç¼ºå°‘å¿…è¦ç« èŠ‚"
              exit 1
            fi
          else
            echo "âŒ $agent ä¸å­˜åœ¨"
            exit 1
          fi
        done
        echo "âœ… Agenté…ç½®éªŒè¯å®Œæˆ"

  documentation-check:
    name: æ–‡æ¡£è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: å®‰è£…markdownlint
      run: |
        npm install -g markdownlint-cli2
        
    - name: æ£€æŸ¥Markdownæ–‡æ¡£è´¨é‡
      run: |
        echo "æ£€æŸ¥Markdownæ–‡æ¡£è´¨é‡..."
        markdownlint-cli2 "**/*.md" "!node_modules" || true
        echo "âœ… æ–‡æ¡£è´¨é‡æ£€æŸ¥å®Œæˆ"
        
    - name: æ£€æŸ¥ä¸­æ–‡æ–‡æ¡£ç¼–ç 
      run: |
        echo "æ£€æŸ¥ä¸­æ–‡æ–‡æ¡£ç¼–ç ..."
        find . -name "*.md" -exec file {} \; | grep -v "UTF-8" || echo "âœ… æ‰€æœ‰æ–‡æ¡£éƒ½æ˜¯UTF-8ç¼–ç "

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ‰«ææ•æ„Ÿä¿¡æ¯
      run: |
        echo "æ‰«ææ½œåœ¨çš„æ•æ„Ÿä¿¡æ¯..."
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†é’¥æˆ–å¯†ç 
        if grep -r -E "(password|secret|key|token).*[:=].*['\"][^'\"]{8,}['\"]" . --exclude-dir=.git --exclude="*.yml" --exclude="*.yaml" || true; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥"
        else
          echo "âœ… æœªå‘ç°æ˜æ˜¾çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
        fi
        
    - name: æ£€æŸ¥æ–‡ä»¶æƒé™
      run: |
        echo "æ£€æŸ¥å…³é”®æ–‡ä»¶æƒé™..."
        find scripts/ -name "*.sh" -perm /111 | wc -l
        echo "âœ… è„šæœ¬æƒé™æ£€æŸ¥å®Œæˆ"

  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æµ‹è¯•Git Worktreeè„šæœ¬
      run: |
        echo "æµ‹è¯•Git Worktreeç®¡ç†è„šæœ¬..."
        chmod +x scripts/git-worktree-manager.sh
        # æµ‹è¯•è„šæœ¬å¸®åŠ©åŠŸèƒ½
        ./scripts/git-worktree-manager.sh --help || echo "è„šæœ¬å¸®åŠ©åŠŸèƒ½æµ‹è¯•å®Œæˆ"
        echo "âœ… Git Worktreeè„šæœ¬åŸºæœ¬åŠŸèƒ½æ­£å¸¸"
        
    - name: éªŒè¯é…ç½®æ–‡ä»¶å…³è”æ€§
      run: |
        echo "éªŒè¯é…ç½®æ–‡ä»¶ä¹‹é—´çš„å…³è”æ€§..."
        # æ£€æŸ¥CLAUDE.mdä¸­å¼•ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        python3 -c "
import re
import os

with open('CLAUDE.md', 'r', encoding='utf-8') as f:
    content = f.read()

# æ£€æŸ¥å¼•ç”¨çš„é…ç½®æ–‡ä»¶
config_refs = re.findall(r'@([^@\s]+\.yaml)', content)
for ref in set(config_refs):
    if os.path.exists(f'config/{ref}'):
        print(f'âœ… {ref} é…ç½®æ–‡ä»¶å­˜åœ¨')
    else:
        print(f'âŒ {ref} é…ç½®æ–‡ä»¶ç¼ºå¤±')

print('âœ… é…ç½®æ–‡ä»¶å…³è”æ€§éªŒè¯å®Œæˆ')
"

  performance-check:
    name: æ€§èƒ½æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥æ–‡ä»¶å¤§å°
      run: |
        echo "æ£€æŸ¥å¤§æ–‡ä»¶..."
        find . -type f -size +1M -not -path "./.git/*" | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "âš ï¸ å¤§æ–‡ä»¶: $file ($size)"
        done || echo "âœ… æ— å¼‚å¸¸å¤§æ–‡ä»¶"
        
    - name: ç»Ÿè®¡é¡¹ç›®è§„æ¨¡
      run: |
        echo "=== é¡¹ç›®è§„æ¨¡ç»Ÿè®¡ ==="
        echo "æ€»æ–‡ä»¶æ•°: $(find . -type f -not -path "./.git/*" | wc -l)"
        echo "ä»£ç è¡Œæ•°: $(find . -name "*.md" -o -name "*.yaml" -o -name "*.yml" -o -name "*.sh" | xargs wc -l | tail -1)"
        echo "é…ç½®æ–‡ä»¶æ•°: $(find config/ -name "*.yaml" -o -name "*.yml" | wc -l)"
        echo "Agentæ•°é‡: $(find agents/ -name "*.md" | wc -l)"
        echo "====================="

  # å‘å¸ƒå‡†å¤‡æ£€æŸ¥ï¼ˆä»…åœ¨mainåˆ†æ”¯ï¼‰
  release-readiness:
    name: å‘å¸ƒå‡†å¤‡æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯ä¸€è‡´æ€§..."
        # ä»å¤šä¸ªæ–‡ä»¶ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯è¿›è¡Œå¯¹æ¯”
        if grep -q "v1.0.0" README.md && grep -q "v1.0.0" ROADMAP.md; then
          echo "âœ… ç‰ˆæœ¬ä¿¡æ¯ä¸€è‡´"
        else
          echo "âš ï¸ ç‰ˆæœ¬ä¿¡æ¯å¯èƒ½ä¸ä¸€è‡´ï¼Œè¯·æ£€æŸ¥"
        fi
        
    - name: æ£€æŸ¥å‘å¸ƒæ¸…å•
      run: |
        echo "æ£€æŸ¥å‘å¸ƒå¿…è¦æ–‡ä»¶..."
        release_files=(
          "README.md"
          "CHANGELOG.md"
          "LICENSE"
          "ROADMAP.md"
          "CONTRIBUTING.md"
        )
        
        for file in "${release_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file å·²å‡†å¤‡"
          else
            echo "âš ï¸ $file å¯èƒ½éœ€è¦å‡†å¤‡"
          fi
        done

  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [validate, agent-config-check, documentation-check, security-scan, integration-test, performance-check]
    if: always()
    
    steps:
    - name: æ„å»ºçŠ¶æ€æ€»ç»“
      run: |
        echo "=== CI/CD æµæ°´çº¿æ‰§è¡Œå®Œæˆ ==="
        echo "æ—¶é—´: $(date)"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "=========================="
        
        if [[ "${{ needs.validate.result }}" == "success" && 
              "${{ needs.agent-config-check.result }}" == "success" && 
              "${{ needs.documentation-check.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" && 
              "${{ needs.integration-test.result }}" == "success" && 
              "${{ needs.performance-check.result }}" == "success" ]]; then
          echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ä»£ç è´¨é‡è‰¯å¥½ã€‚"
        else
          echo "âš ï¸ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚"
        fi